#!/usr/bin/env node

/**
 * Agentic QE CLI Entry Point
 * Version: 1.1.0
 *
 * This script imports and executes the comprehensive TypeScript CLI
 * which includes all Phase 1 and Phase 2 commands:
 *
 * Phase 1 (v1.0.5):
 * - Multi-Model Router (routing commands)
 * - Streaming MCP tools
 *
 * Phase 2 (Milestone 2.2):
 * - Learning Engine (learn commands)
 * - Pattern Management (patterns commands)
 * - Continuous Improvement (improve commands)
 * - QE Reasoning Bank integration
 *
 * Core Commands:
 * - init, status, start
 * - workflow (list, pause, cancel)
 * - config (init, validate, get, set, list, reset)
 * - debug (agent, diagnostics, health-check, troubleshoot)
 * - memory (stats, compact)
 */

const path = require('path');
const fs = require('fs');

// Check Node.js version
const MIN_NODE_VERSION = 18;
const currentVersion = parseInt(process.versions.node.split('.')[0]);
if (currentVersion < MIN_NODE_VERSION) {
  console.error(`❌ Error: Node.js ${MIN_NODE_VERSION}+ required. Current: ${process.version}`);
  console.error(`Please upgrade Node.js: https://nodejs.org/`);
  process.exit(1);
}

// Determine CLI path (compiled TypeScript)
const cliPath = path.join(__dirname, '..', 'dist', 'cli', 'index.js');

// Check if build exists
if (!fs.existsSync(cliPath)) {
  console.error('❌ Error: CLI not built. Please run: npm run build');
  console.error('');
  console.error('Build steps:');
  console.error('  cd /workspaces/agentic-qe-cf');
  console.error('  npm install');
  console.error('  npm run build');
  console.error('');
  console.error('After building, try again: aqe --help');
  process.exit(1);
}

// Global error handler
process.on('uncaughtException', (error) => {
  console.error('❌ Unexpected error:', error.message);
  if (process.env.DEBUG || process.env.VERBOSE) {
    console.error('Stack trace:', error.stack);
  }
  console.error('');
  console.error('Please report this issue at:');
  console.error('https://github.com/proffesor-for-testing/agentic-qe/issues');
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error('❌ Unhandled promise rejection:', reason);
  if (process.env.DEBUG || process.env.VERBOSE) {
    console.error('Promise:', promise);
  }
  console.error('');
  console.error('Please report this issue at:');
  console.error('https://github.com/proffesor-for-testing/agentic-qe/issues');
  process.exit(1);
});

// Load and execute the compiled TypeScript CLI
try {
  // Import the CLI module
  require(cliPath);

} catch (error) {
  console.error('❌ Error loading CLI:', error.message);

  if (process.env.DEBUG || process.env.VERBOSE) {
    console.error('');
    console.error('Debug information:');
    console.error('  CLI path:', cliPath);
    console.error('  CLI exists:', fs.existsSync(cliPath));
    console.error('  Node version:', process.version);
    console.error('  Platform:', process.platform);
    console.error('  Stack trace:', error.stack);
  } else {
    console.error('');
    console.error('Run with DEBUG=1 for detailed error information:');
    console.error('  DEBUG=1 aqe --help');
  }

  console.error('');
  console.error('Troubleshooting:');
  console.error('  1. Rebuild: npm run build');
  console.error('  2. Reinstall: npm install');
  console.error('  3. Check Node.js version: node --version (require 18+)');
  console.error('');
  console.error('If the issue persists, please report at:');
  console.error('https://github.com/proffesor-for-testing/agentic-qe/issues');

  process.exit(1);
}
